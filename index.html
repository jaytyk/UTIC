<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²½ë¡œ ê¸°ë°˜ UTIC CCTV ë·°ì–´</title>
    
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; margin: 0; background-color: #f4f4f4; }
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; display: flex; gap: 20px; }
        h1 { text-align: center; color: #333; }
        
        /* ì¢Œì¸¡ ì œì–´íŒ ì˜ì—­ */
        .sidebar { width: 350px; flex-shrink: 0; background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input[type="text"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        
        .api-input-section { margin-bottom: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 4px; background-color: #fff8e1; }
        .api-input-section input { margin-bottom: 5px; }
        .api-input-section button { padding: 5px 10px; margin-top: 5px; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .api-input-section button:hover { background-color: #e68900; }

        #search-button { width: 100%; padding: 10px; background-color: #ffcd00; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; }
        #search-button:hover:not(:disabled) { background-color: #e6b800; }
        #search-button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #map-area { margin-top: 20px; height: 300px; border: 1px solid #ccc; border-radius: 4px; }
        #cctv-count { font-weight: bold; margin-top: 10px; }

        /* ìš°ì¸¡ ë·°ì–´ ì˜ì—­ */
        .viewer-area { flex-grow: 1; }
        #cctv-viewer { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .cctv-item { background-color: #000; position: relative; overflow: hidden; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); min-height: 200px; }
        .cctv-item iframe { width: 100%; height: 100%; border: none; }
        .cctv-title { position: absolute; top: 5px; left: 5px; color: white; background-color: rgba(0, 0, 0, 0.5); padding: 2px 5px; border-radius: 3px; font-size: 12px; }

        /* ê°€ë¡œ 2~4ê°œ ë ˆì´ì•„ì›ƒ */
        .cols-2 .cctv-item { width: calc(50% - 5px); }
        .cols-3 .cctv-item { width: calc(33.333% - 7px); }
        .cols-4 .cctv-item { width: calc(25% - 8px); }
    </style>
</head>
<body>

    <header>
        <h1>ê²½ë¡œ ê¸°ë°˜ UTIC CCTV ë·°ì–´</h1>
    </header>

    <div class="container">
        <div class="sidebar">
            
            <div class="api-input-section">
                <h3>ğŸ”‘ API í‚¤ ì„¤ì • (ë¡œì»¬ ì €ì¥)</h3>
                <div class="input-group">
                    <label for="kakao-key-input">ì¹´ì¹´ì˜¤ë§µ JavaScript API í‚¤:</label>
                    <input type="text" id="kakao-key-input" placeholder="í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="input-group">
                    <label for="utic-key-input">UTIC API í‚¤:</label>
                    <input type="text" id="utic-key-input" placeholder="í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <button onclick="saveApiKeys()">API í‚¤ ì €ì¥ ë° ì„œë¹„ìŠ¤ ë¡œë“œ</button>
                <p style="font-size: 12px; margin-top: 5px;">* í‚¤ëŠ” ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ë©°, ë¸Œë¼ìš°ì € ì¢…ë£Œ í›„ì—ë„ ìœ ì§€ë©ë‹ˆë‹¤.</p>
            </div>

            <h2>ê²½ë¡œ ê²€ìƒ‰</h2>

            <div class="input-group">
                <label for="start-point">ì¶œë°œì§€ (ì˜ˆ: ì„œìš¸ì—­):</label>
                <input type="text" id="start-point" value="ì„œìš¸ì—­">
            </div>

            <div class="input-group">
                <label for="end-point">ë„ì°©ì§€ (ì˜ˆ: ë¶€ì‚°ì—­):</label>
                <input type="text" id="end-point" value="ë¶€ì‚°ì—­">
            </div>
            
            <div class="input-group">
                <label for="column-count">í™”ë©´ ê°€ë¡œ ë°°ì—´ ê°œìˆ˜:</label>
                <select id="column-count">
                    <option value="2">2ê°œ</option>
                    <option value="3" selected>3ê°œ</option>
                    <option value="4">4ê°œ</option>
                </select>
            </div>

            <button id="search-button" onclick="findRouteAndCCTVs()" disabled>API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥/ì €ì¥í•˜ì„¸ìš”</button>

            <div id="map-area"></div>
            <p id="cctv-count"></p>
        </div>

        <div class="viewer-area">
            <h2>ê²½ë¡œ CCTV í™”ë©´</h2>
            <div id="cctv-viewer" class="cols-3">
                <p>API í‚¤ë¥¼ ì…ë ¥í•˜ê³  'API í‚¤ ì €ì¥ ë° ì„œë¹„ìŠ¤ ë¡œë“œ' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            </div>
        </div>
    </div>

    <script>
        const UTIC_BASE_STREAM_URL = 'https://www.utic.go.kr/jsp/map/cctvStream.jsp?';
        const KAKAO_KEY_STORAGE_KEY = 'kakaoMapApiKey';
        const UTIC_KEY_STORAGE_KEY = 'uticApiKey';

        let KAKAO_API_KEY = localStorage.getItem(KAKAO_KEY_STORAGE_KEY) || null;
        let UTIC_API_KEY = localStorage.getItem(UTIC_KEY_STORAGE_KEY) || null;

        // ì¹´ì¹´ì˜¤ ì§€ë„ ë° ì„œë¹„ìŠ¤ ê°ì²´ (ë¡œë“œ í›„ ì´ˆê¸°í™”ë¨)
        let map = null;
        let ps = null; // Places Service (ì¥ì†Œ ê²€ìƒ‰)
        let routePolyline = null;
        let markerStart = null;
        let markerEnd = null;

        /**
         * API í‚¤ ì…ë ¥ í•„ë“œë¥¼ ë¡œì»¬ ì €ì¥ì†Œ ê°’ìœ¼ë¡œ ì±„ìš°ê³ , í‚¤ê°€ ìˆìœ¼ë©´ ì„œë¹„ìŠ¤ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
         */
        function initializeApiInputs() {
            document.getElementById('kakao-key-input').value = KAKAO_API_KEY || '';
            document.getElementById('utic-key-input').value = UTIC_API_KEY || '';

            if (KAKAO_API_KEY && UTIC_API_KEY) {
                loadKakaoMapScript(KAKAO_API_KEY);
            }
        }
        
        /**
         * API í‚¤ë¥¼ ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥í•˜ê³  ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
         */
        function saveApiKeys() {
            const kakaoKey = document.getElementById('kakao-key-input').value.trim();
            const uticKey = document.getElementById('utic-key-input').value.trim();

            if (!kakaoKey || !uticKey) {
                alert('ì¹´ì¹´ì˜¤ë§µ API í‚¤ì™€ UTIC API í‚¤ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            // ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥
            localStorage.setItem(KAKAO_KEY_STORAGE_KEY, kakaoKey);
            localStorage.setItem(UTIC_KEY_STORAGE_KEY, uticKey);

            KAKAO_API_KEY = kakaoKey;
            UTIC_API_KEY = uticKey;
            
            alert('API í‚¤ê°€ ì €ì¥ë˜ì—ˆê³  ì„œë¹„ìŠ¤ ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.');
            loadKakaoMapScript(KAKAO_API_KEY);
        }

        /**
         * ì¹´ì¹´ì˜¤ë§µ JavaScript SDKë¥¼ ë™ì ìœ¼ë¡œ ë¡œë“œí•©ë‹ˆë‹¤.
         */
        function loadKakaoMapScript(key) {
            if (document.getElementById('kakao-map-script')) {
                // ì´ë¯¸ ë¡œë“œë˜ì—ˆê±°ë‚˜ ë¡œë“œ ì¤‘ì´ë©´ ì¬ë¡œë“œí•˜ì§€ ì•ŠìŒ (ë‹¨ìˆœíˆ ì„œë¹„ìŠ¤ í™œì„±í™”)
                initializeServices();
                return;
            }

            const script = document.createElement('script');
            script.id = 'kakao-map-script';
            script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${key}&libraries=services`;
            script.onload = () => {
                kakao.maps.load(initializeServices);
            };
            document.head.appendChild(script);
        }

        /**
         * ì¹´ì¹´ì˜¤ ì„œë¹„ìŠ¤ ê°ì²´ë¥¼ ì´ˆê¸°í™”í•˜ê³  ë§µì„ í‘œì‹œí•˜ë©° ê²€ìƒ‰ ë²„íŠ¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.
         */
        function initializeServices() {
            const mapContainer = document.getElementById('map-area');
            const defaultCenter = new kakao.maps.LatLng(36.5, 127.5);
            const mapOption = { center: defaultCenter, level: 13 };
            
            map = new kakao.maps.Map(mapContainer, mapOption);
            ps = new kakao.maps.services.Places(); // ì¥ì†Œ ê²€ìƒ‰ ì„œë¹„ìŠ¤ ì´ˆê¸°í™”

            // ê²€ìƒ‰ ë²„íŠ¼ í™œì„±í™”
            document.getElementById('search-button').disabled = false;
            document.getElementById('search-button').textContent = 'ê²½ë¡œ ê²€ìƒ‰ ë° CCTV ì¡°íšŒ';
            
            document.getElementById('cctv-viewer').innerHTML = '<p>ì¶œë°œì§€/ë„ì°©ì§€ë¥¼ ì…ë ¥í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>';
        }

        // --- ë©”ì¸ íë¦„ í•¨ìˆ˜ ---
        
        async function findRouteAndCCTVs() {
            if (!KAKAO_API_KEY || !UTIC_API_KEY) {
                alert('API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            const startName = document.getElementById('start-point').value;
            const endName = document.getElementById('end-point').value;
            const searchButton = document.getElementById('search-button');
            
            searchButton.disabled = true;
            searchButton.textContent = 'ê²½ë¡œ ê²€ìƒ‰ ì¤‘...';
            document.getElementById('cctv-viewer').innerHTML = '<p>ê²½ë¡œ ê²€ìƒ‰ ë° CCTV ì •ë³´ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...</p>';

            try {
                // 1. ì¶œë°œì§€/ë„ì°©ì§€ ì¢Œí‘œ íšë“ (ì¹´ì¹´ì˜¤ë§µ API)
                const startCoords = await getCoordsByName(startName);
                const endCoords = await getCoordsByName(endName);
                
                if (!startCoords || !endCoords) {
                    throw new Error('ì¶œë°œì§€ ë˜ëŠ” ë„ì°©ì§€ ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                // 2. UTIC APIë¥¼ ì‚¬ìš©í•˜ì—¬ ê²½ë¡œ ìƒì˜ CCTV ì¡°íšŒ
                // *** CORS ë¬¸ì œ ë°œìƒ ê°€ëŠ¥ì„± ë†’ìŒ. ì‹¤ì œ ì‚¬ìš© ì „ UTIC API CORS í—ˆìš© ì—¬ë¶€ í™•ì¸ í•„ìˆ˜. ***
                const uticCctvApiUrl = `https://openapi.utic.go.kr/api/getRouteCctvList?key=${UTIC_API_KEY}&startLat=${startCoords.y}&startLon=${startCoords.x}&endLat=${endCoords.y}&endLon=${endCoords.x}`;
                
                const response = await fetch(uticCctvApiUrl);
                
                if (!response.ok) {
                    throw new Error(`UTIC API í˜¸ì¶œ ì‹¤íŒ¨: ìƒíƒœ ì½”ë“œ ${response.status}`);
                }
                
                const data = await response.json();
                
                // 3. UTIC API ê²°ê³¼ì—ì„œ CCTV ëª©ë¡ ì¶”ì¶œ (UTIC API ì‘ë‹µ í˜•ì‹ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
                // ì•„ë˜ëŠ” UTIC APIê°€ 'data.cctvList' ë°°ì—´ì„ ë°˜í™˜í•œë‹¤ê³  ê°€ì •í•œ í˜•ì‹ì…ë‹ˆë‹¤.
                // ì‹¤ì œ ì‘ë‹µ êµ¬ì¡°ë¥¼ í™•ì¸í•˜ì—¬ ìˆ˜ì •í•˜ì„¸ìš”.
                const cctvList = data.cctvList || []; 

                // 4. ì§€ë„ì— ê²½ë¡œì™€ ë§ˆì»¤ í‘œì‹œ
                drawMapRoute(startCoords, endCoords, cctvList);
                
                // 5. CCTV ë·°ì–´ ë Œë”ë§
                renderCCTVViewer(cctvList);

            } catch (error) {
                console.error("ì„œë¹„ìŠ¤ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                document.getElementById('cctv-viewer').innerHTML = `<p style="color: red;">ì˜¤ë¥˜ ë°œìƒ: ${error.message}. API í‚¤ë‚˜ UTIC API ì‘ë‹µ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.</p>`;
            } finally {
                searchButton.disabled = false;
                searchButton.textContent = 'ê²½ë¡œ ê²€ìƒ‰ ë° CCTV ì¡°íšŒ';
            }
        }

        /**
         * ì¥ì†Œ ì´ë¦„ìœ¼ë¡œ ì¢Œí‘œ (WGS84, Lat/Lon)ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤. (ì¹´ì¹´ì˜¤ë§µ ì„œë¹„ìŠ¤)
         */
        function getCoordsByName(name) {
            return new Promise((resolve, reject) => {
                ps.keywordSearch(name, (data, status, pagination) => {
                    if (status === kakao.maps.services.Status.OK) {
                        resolve({ x: data[0].x, y: data[0].y });
                    } else {
                        resolve(null);
                    }
                });
            });
        }
        
        /**
         * ì¹´ì¹´ì˜¤ë§µì— ê²½ë¡œ ë° ë§ˆì»¤ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function drawMapRoute(startCoords, endCoords, cctvList) {
            // ê¸°ì¡´ ë§ˆì»¤ ë° ê²½ë¡œ ì œê±°
            if (routePolyline) routePolyline.setMap(null);
            if (markerStart) markerStart.setMap(null);
            if (markerEnd) markerEnd.setMap(null);
            
            // ... (ì´í•˜ drawMapRoute í•¨ìˆ˜ ë‚´ìš©ì€ ì´ì „ ì½”ë“œì™€ ë™ì¼)
            // ì§€ë„ ë§ˆì»¤ ë° ê²½ë¡œë¥¼ ê·¸ë¦¬ëŠ” ì½”ë“œë¥¼ ì—¬ê¸°ì— í¬í•¨
            
            const bounds = new kakao.maps.LatLngBounds();
            const startPos = new kakao.maps.LatLng(startCoords.y, startCoords.x);
            const endPos = new kakao.maps.LatLng(endCoords.y, endCoords.x);
            bounds.extend(startPos);
            bounds.extend(endPos);
            
            map.setBounds(bounds);
            
            // ë§ˆì»¤ í‘œì‹œ
            markerStart = new kakao.maps.Marker({ position: startPos, map: map, title: 'ì¶œë°œì§€' });
            markerEnd = new kakao.maps.Marker({ position: endPos, map: map, title: 'ë„ì°©ì§€' });

            // [ì„ì‹œ] ì¶œë°œì§€/ë„ì°©ì§€ ì‚¬ì´ì˜ ì§ì„  ê²½ë¡œ í‘œì‹œ
            routePolyline = new kakao.maps.Polyline({
                path: [startPos, endPos],
                strokeWeight: 5,
                strokeColor: '#FF0000',
                strokeOpacity: 0.7,
                strokeStyle: 'solid'
            });
            routePolyline.setMap(map);
            
            // CCTV ë§ˆì»¤ í‘œì‹œ (UTIC ì‘ë‹µ í˜•ì‹ì— ë§ê²Œ lat/lon í•„ë“œëª… í™•ì¸ í›„ ìˆ˜ì • í•„ìš”)
            cctvList.forEach(cctv => {
                 // cctv.lat, cctv.lon ì´ ìˆë‹¤ê³  ê°€ì •
                 if (cctv.lat && cctv.lon) {
                    const cctvPos = new kakao.maps.LatLng(cctv.lat, cctv.lon);
                    const cctvMarker = new kakao.maps.Marker({ 
                        position: cctvPos, 
                        map: map, 
                        title: cctv.cctvname || 'CCTV',
                        image: new kakao.maps.MarkerImage(
                            'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png',
                            new kakao.maps.Size(24, 35),
                            { offset: new kakao.maps.Point(12, 35) }
                        )
                    });
                    
                    kakao.maps.event.addListener(cctvMarker, 'click', function() {
                        const targetElement = document.getElementById(`cctv-${cctv.cctvid}`);
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                 }
            });

            document.getElementById('cctv-count').textContent = `ê²½ë¡œ ì£¼ë³€ CCTV: ${cctvList.length}ê°œ ë°œê²¬`;

        }

        /**
         * CCTV ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ë·°ì–´ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderCCTVViewer(cctvList) {
            const viewer = document.getElementById('cctv-viewer');
            const columnCount = document.getElementById('column-count').value;
            viewer.innerHTML = '';
            
            viewer.className = `cols-${columnCount}`;

            if (cctvList.length === 0) {
                 viewer.innerHTML = '<p>ê²½ë¡œ ì£¼ë³€ì—ì„œ CCTVë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                 return;
            }

            cctvList.forEach(cctv => {
                // UTIC API ì‘ë‹µì—ì„œ cctvid, cctvname, cctvip ë“± í•„ìˆ˜ íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
                // ì•„ë˜ëŠ” UTIC ê¸°ì¡´ URL í˜•ì‹ì— ë§ê²Œ íŒŒë¼ë¯¸í„°ë¥¼ ì¬êµ¬ì„±í•œ ì˜ˆì‹œì…ë‹ˆë‹¤.
                const params = `cctvid=${cctv.cctvid}&cctvname=${encodeURIComponent(cctv.cctvname)}&kind=${cctv.kind || 'EE'}&cctvip=${cctv.cctvip}&cctvch=${cctv.cctvch || 'undefined'}&id=undefined&cctvpasswd=undefined&cctvport=undefined&minX=${cctv.minX || ''}&minY=${cctv.minY || ''}&maxX=${cctv.maxX || ''}&maxY=${cctv.maxY || ''}`;
                const fullUrl = UTIC_BASE_STREAM_URL + params;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'cctv-item';
                itemDiv.id = `cctv-${cctv.cctvid}`;

                const titleSpan = document.createElement('span');
                titleSpan.className = 'cctv-title';
                titleSpan.textContent = cctv.cctvname;

                const iframe = document.createElement('iframe');
                iframe.src = fullUrl;
                iframe.setAttribute('loading', 'lazy'); 
                iframe.setAttribute('allow', 'autoplay');

                itemDiv.appendChild(iframe);
                itemDiv.appendChild(titleSpan);
                viewer.appendChild(itemDiv);
            });
        }
        
        document.getElementById('column-count').addEventListener('change', () => {
             const viewer = document.getElementById('cctv-viewer');
             // í´ë˜ìŠ¤ ë³€ê²½ìœ¼ë¡œ CSS ë ˆì´ì•„ì›ƒë§Œ ì—…ë°ì´íŠ¸
             viewer.className = `cols-${document.getElementById('column-count').value}`;
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ API í‚¤ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ë° ì„œë¹„ìŠ¤ ë¡œë“œ ì‹œë„
        document.addEventListener('DOMContentLoaded', initializeApiInputs);

    </script>
</body>
</html>
